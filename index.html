<!doctype html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>matt</title>
	<meta name="description" content="mqtt Home Automation Dashboard">
	<meta name="author" content="Marco Koch">

	<meta name="viewport" content="width=device-width,initial-scale=1">

	<link rel="stylesheet" href="./style.css">

	<script src="mqttws31.js"></script>
	<script src="jquery-1.7.1.min.js"></script>
	<script src="knockout.js"></script>
	
	<script>
$( document ).ready(function() {
	client = new Messaging.Client("172.16.0.70", 80, "matt");
	// set callback handlers
	client.onConnectionLost = onConnectionLost;
	client.onMessageArrived = onMessageArrived;

	// connect the client
	client.connect({onSuccess:onConnect});


	// called when the client connects
	function onConnect() {
  	// Once a connection has been made, make a subscription and send a message.
  	console.log("onConnect");
  	client.subscribe("byteli/light/1/state");
	client.subscribe("vw/heater/state")
	}

	// called when the client loses its connection
	function onConnectionLost(responseObject) {
  	if (responseObject.errorCode !== 0) {
    	console.log("onConnectionLost:"+responseObject.errorMessage);
  	}
	}

	// called when a message arrives
	function onMessageArrived(message) {
	  console.log("onMessageArrived:"+message.payloadString);
	}


	var device = function(topic)
	{
		var self = this;
		self.deviceTopic = topic;
		
		self.sendToggle = function()
		{
		        message = new Messaging.Message("toggle");
        		message.destinationName = self.deviceTopic;
        		client.send(message); 
		}
		
		self.sendOn = function()
		{
		        message = new Messaging.Message("on");
                        message.destinationName = self.deviceTopic;
                        client.send(message);
		}
		
		self.sendOff = function()
		{
		        message = new Messaging.Message("off");
                        message.destinationName = self.deviceTopic;
                        client.send(message); 
		}
	}
	
	
	var mattViewModel = function()
	{
		led    = new device("byteli/light/1");
		heater = new device("vw/heater");
	};
	
	$(document).ready(function()
	{
		ko.applyBindings(new mattViewModel());
	})

	
});
	</script>
	
</head>
<body>

	<div>
		<p>byteli/light/1</p>
		<button class="myButton" data-bind='click: led.sendOn'>on</button>
		<button class="myButton" data-bind='click: led.sendOff'>off</button>
		<button class="myButton" data-bind='click: led.sendToggle'>toggle</button>
		<br/>
		<p>VW Büssli Heizöffeli (vw/heater)</p>
                <button class="myButton" data-bind='click: heater.sendOn'>on</button>
                <button class="myButton" data-bind='click: heater.sendOff'>off</button>
                <button class="myButton" data-bind='click: heater.sendToggle'>toggle</button>
	</div>

</body>
</html>
